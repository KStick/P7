<DOCTYPE html>
<head>
	<link rel="stylesheet" type="text/css" href="loginPageCSS.css">
    <link rel="stylesheet" type="text/css" href="globalCSS.css">
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script> 
    <script src="Scripts/sjcl.js"></script>
    <!--
        ServerURL change to contact another server
    -->
    <input type="hidden" id="serverCWD" value="http://172.17.244.136/P7/proofOfConcept"></input>
    <input type="hidden" id="REST" value="http://172.17.244.136:5000"></input>

</head>


<html>
<body>
    <div class = "main-body">
        <div class = "top-banner">
            
        </div>
        <div class = "login-form">
            <div class = "form-header-holder">
                <h3>Register</h3>
            </div>
            <div class = "form-input-holder">
                <form onsubmit="createUser(loginName.value, password.value, repeat_password.value, email.value, role.value); return false;" autocomplete="on">
                    <p>Account name</p>
                    <input type = "text" placeholder="Insert username..." id="loginName" autofocus required>
                    <p>Password</p>
                    <input type = "password" placeholder="Insert password..." id="password" required>
                    <input type = "password" placeholder="Repeat password..." id="repeat_password" required>
                    <p>Email</p>
                    <input type = "email" placeholder="Insert email..." id="email" required>
                    <p>Role</p>
                    <select id="role" required>
                        <option value=""> -- select role --</option>
                        <option value="student">student</option>
                        <option value="tutor">tutor</option>
                    </select><br><br>
                    <input type="submit" value="register">
                </form>
            </div>
        </div>
    </div>
</body>
</html>


<script type="text/javascript">
    serverCWD = document.getElementById("serverCWD").value.toString();
    REST = document.getElementById("REST").value.toString();

    function createUser(username, password, repeat_password, email, role){
        if (password == repeat_password) {
            var url = REST + '/GenerateSalt';
            $.ajax({data:{username},
                type:"POST",
                url: url,
                headers: {
                    'Access-Control-Allow-Origin': '*'
                },
                success: function(response) {
                    url = REST + "/CreateUser"
                    var salt = response
                    var bitArray = sjcl.hash.sha256.hash(salt + password)
                    var key = sjcl.codec.base64.fromBits(bitArray)
                    $.ajax({data:{username, key, email, role, salt},

                    type:"POST",
                    url: url,
                    headers: {
                    'Access-Control-Allow-Origin': '*'
                },
                    success: function(response) {
                        if (response=="tutor") {
                            document.cookie="Username = " + username + ";path=/" 
                            window.location.href = serverCWD + "/subject/tutor_queue.html"
                        }
                        else if (response=="student") {
                            document.cookie="Username = " + username + ";path=/" 
                            window.location.href = serverCWD + "/subject/student_subject.html"
                        }
                        else if(response=="username_taken"){
                            alert('Username is taken');
                        }
    
                    },
                    error: function(error){
                    console.log(error);
                }
            }) 

                },
                error: function(error){
                    console.log(error)
                }
            })
        }
        else{
            alert('Passwords did not match!');
        }
    }
</script>



