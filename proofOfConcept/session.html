<DOCTYPE html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="globalCSS.css">
    <link rel="stylesheet" type="text/css" href="session.css">
	<script src="Scripts/fabric.js"></script>
	<script src="Scripts/videoWorker.js" type="text/javascript"></script>
	<script src="Scripts/WSVideoStream.js" type="text/javascript"></script>
</head>


<html>

<body onunload="leaveSession()">
	<input type="hidden" id="videoWSURL" value="ws://localhost:8080/websocket"></input>
 

	<div class = "main-body">
        <div class = "left-container">
            <div class = "webcam-container top">
            	<video autoplay="true" id="videoElement" width="320" height="240"> </video>
            </div>
            <div class = "menu-bar">
                <button id = "drawingMode">
                   Cancel drawing mode 
                </button>
                <button id = "clear">
                    Clear
                </button>
                <select id="drawingModeSelector">
                    <option>Pencil</option>
                    <option>Circle</option>
                    <option>Spray</option>
                 </select>
                <span class="info">30</span><input type="range" value="30" min="0" max="150" id="drawingLineWidth">
                <input type="color" value="#005E7A" id="drawingColor"><br>
            </div>
            <div class = "webcam-container bottom">
            	<image id="videoimage"> </canvas>
            </div>
        </div>
        
		<div class="visual-box">
            <canvas id = "whiteboard">
                
            </canvas>
		</div>

		<div id="chat-container">
			<textarea id="message-box"></textarea>
			<div id="name-bar">
				<p id="name-bar-p">Session Live Chat!</p>
				<button id="nav-bar">-</button> 
			</div>
			<div id="box">
			</div>
		</div>
	
	</div>
	
<script type="text/javascript">
	function deleteSessionCookie() {
		document.cookie = "SessionID " + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
	}

	function leaveSession(){
		userLeavesChat();
		deleteSessionCookie();
	}

	function getCookie(name) {
		var value = "; " + document.cookie;
	    var parts = value.split("; " + name + "=");
	    if (parts.length == 2) 
	    	return parts.pop().split(";").shift();
	}

	function saveWhiteboard() {
		var ID = getCookie("SessionID");
		var tmp = JSON.stringify(canvas.toJSON());
		$.post("Php/Post.php", {sessionID : ID, data : tmp});
	}

	function loadWhiteboard() {
		var ID = getCookie("SessionID");
		$(function(){
   			$.get( "Sessions/".concat(ID), function( data ) {
					canvas.loadFromJSON(decodeEntities(data), function() {
   			 		canvas.renderAll();
				}); 
   			});
		});
	}

	function decodeEntities(encodedString) {
    	var textArea = document.createElement('textarea');
    	textArea.innerHTML = encodedString;
    	return textArea.value;
	}

	function setSize() {
        var height = $(window).height();
        var width = $(window).width();
        
        canvas.setDimensions({
            width: width,
            height: height
        });
        
        //canvas.calcOffset();
        canvas.renderAll();
    };

	//Loads the log to write the chat. This function is called at an interval
	 function loadLog(){
        var sessionID = getCookie("SessionID");
        var oldScrollHeight = $("#box")[0].scrollHeight;
        var path = "SessionsChatlogs/" + sessionID + ".html";
        $.ajax({
            url: path,
            cache: false,
            success: function(html){

               $("#box").html(decodeEntities(html)); //Insert chat log into the #chatbox div
               if (oldScrollHeight < $("#box")[0].scrollHeight) {
               	$("#box").scrollTop($("#box")[0].scrollHeight);			
               }   
                              
            },
        });

  
    }	
	function userJoinsChat() {
		var clientmsg = username + " has joined the chat!";
		$.post("Php/postchatlog.php", {username : "System", text : clientmsg, sessionID : sessionID});
	}

	function userLeavesChat() {
		var clientmsg = username + " has left the chat!";
		$.post("Php/postchatlog.php", {username : "System", text : clientmsg, sessionID : sessionID});
	}

	function minimizeChat() {
		document.getElementById("chat-container").style.height = '2.8%';
		document.getElementById("message-box").style.display = "none";
		document.getElementById("box").style.display = "none";
	}

	function maximizeChat()  {
		document.getElementById("chat-container").style.height = '30%';
		document.getElementById("message-box").style.display = "block";
		document.getElementById("box").style.display = "block";

	}

	var session = getCookie("SessionID");
	$.post("Php/Session.php", {id : session});
</script>

<script>
    var width = 0;
	var height = 0;
	var canvas;
	var username = getCookie("Username");
	var sessionID = getCookie("SessionID");

	$(document).ready(function(){
		var image = document.getElementById('videoimage');
		var video = document.getElementById('videoElement');
		var wsVIDEO = document.getElementById("videoWSURL").value.toString();


 		$.ajax({
            url: "http://localhost:5000/GetRole/" + username,
            cache: false,
            success: function(response){
            	console.log(response)
            	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;
		 
				if (navigator.getUserMedia) {       
				    navigator.getUserMedia({video: true}, handleVideo, videoError);
				}
					 
				function handleVideo(stream) {
				    video.src = window.URL.createObjectURL(stream);
				    localVideoRec = new WSVideoStream(stream, wsVIDEO, response + "," + sessionID, image);
			    	setTimeout(function () { localVideoRec.record(); }, 500);
				}
				 
				function videoError(e) {
				    Console.log(e);
				}
            },
        });

		window.onload = userJoinsChat();
		// whiteboard functions
		width = document.getElementById("whiteboard").offsetWidth;
		height = document.getElementById("whiteboard").offsetHeight;
		canvas = new fabric.Canvas("whiteboard" , {isDrawingMode: true});
		canvas.setWidth(width);
		canvas.setHeight(height);
		canvas.freeDrawingBrush.color = drawingColor.value;		
		loadWhiteboard();
		
		setInterval(loadWhiteboard, 1000);
		canvas.on('path:created', function(e){	
			saveWhiteboard();

		});	

		$(window).resize(function() {
			setSize();
		}); 

		// chat functions

		$("#nav-bar").click(function() {
		    if (document.getElementById("nav-bar").innerHTML == "-") {
		    	minimizeChat();
		    	document.getElementById("nav-bar").innerHTML = "+";
		    }
		    else {
		    	maximizeChat();
		    	document.getElementById("nav-bar").innerHTML = "-";
		    }
		});

		setInterval(loadLog, 300);

		$("#message-box").keyup(function(event){
			if(event.keyCode == 13){
				var message = document.getElementById("message-box").value;
				$.post("Php/postchatlog.php", {username : username, text : message, sessionID : sessionID});
				$('#message-box').val("", "");

			}
		});

	})
	var drawingModeEL = document.getElementById("drawingMode"),
		clearEL = document.getElementById("clear"),
		drawingLineWidthEL = document.getElementById("drawingLineWidth"),
		drawingColorEL = document.getElementById("drawingColor");

	clearEL.onclick = function() { 
		canvas.clear();
		saveWhiteboard();
	}
	
	drawingModeEL.onclick = function() {
		canvas.isDrawingMode = !canvas.isDrawingMode;
		if(canvas.isDrawingMode){
			drawingModeEL.innerHTML = "Cancel drawing mode";
		}
		else {
			drawingModeEL.innerHTML = "Enter drawing mode";
		}};
	
	document.getElementById('drawingModeSelector').onchange = function() {
		if(this.value === ""){
			<!--here we can make custom brushes-->
		}	
		else {
			canvas.freeDrawingBrush = new fabric[this.value + 'Brush'](canvas);
		}
		
		canvas.freeDrawingBrush.color = drawingColor.value;
		canvas.freeDrawingBrush.width = parseInt(drawingLineWidthEL.value,10) || 1;
	}
	
	drawingLineWidthEL.onchange = function(){
		canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
		this.previousSibling.innerHTML= this.value;
	}

	drawingColor.onchange = function() {
		canvas.freeDrawingBrush.color = this.value;
	}

</script>

</body>
</html>
